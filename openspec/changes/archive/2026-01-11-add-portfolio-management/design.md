# 持仓管理功能设计文档

## Context

基于对 fin-agent 项目优秀实践的学习，设计一个完整的持仓管理系统。当前项目已有基础的PortfolioService和Agent框架，需要在此基础上构建完整的持仓管理功能，包括前端界面、后端服务、AI分析和定时任务等。

**约束条件**:
- 需要兼容现有的数据库结构和服务架构
- 前端使用Vue 3 + TypeScript技术栈
- 后端基于FastAPI和现有的Agent框架
- 数据存储使用ClickHouse数据库

**利益相关者**:
- 终端用户：需要直观易用的持仓管理界面
- 开发团队：需要可维护和可扩展的代码架构
- 运维团队：需要稳定可靠的定时任务系统

## Goals / Non-Goals

**Goals**:
- 提供完整的持仓CRUD功能，支持股票代码、数量、成本价、买入日期等信息管理
- 实现实时盈亏计算，基于最新行情数据自动更新持仓价值
- 构建AI驱动的持仓分析系统，提供技术面、基本面和风险评估
- 建立每日自动分析机制，生成个性化投资报告
- 开发直观的前端界面，支持图表展示和交互操作

**Non-Goals**:
- 不实现实际的股票交易功能（仅记录和分析）
- 不提供实时推送功能（使用定时刷新）
- 不支持多用户权限管理（单用户系统）

## Decisions

### 架构决策

**决策1: 采用分层架构设计**
- **选择**: 前端组件 -> API接口 -> 服务层 -> 数据层的分层架构
- **原因**: 符合现有项目架构，便于维护和测试
- **替代方案**: 微服务架构（过于复杂，不适合当前规模）

**决策2: 使用Agent模式进行AI分析**
- **选择**: 基于现有LangGraphAgent框架扩展PortfolioAgent
- **原因**: 复用现有框架，保持一致性，支持复杂的分析逻辑
- **替代方案**: 简单的规则引擎（功能有限，无法提供智能分析）

**决策3: 采用定时任务进行每日分析**
- **选择**: 使用Celery或类似的任务队列系统
- **原因**: 支持可靠的异步执行，便于监控和错误处理
- **替代方案**: 简单的cron任务（缺乏错误处理和监控）

### 数据模型决策

**决策4: 基于ClickHouse设计数据表结构**
- **选择**: 使用ClickHouse的ReplacingMergeTree引擎设计持仓相关表
- **原因**: 
  - 支持高效的时间序列数据存储和查询
  - ReplacingMergeTree自动处理数据去重，适合持仓更新场景
  - 列式存储提供优异的分析查询性能
- **替代方案**: 传统关系型数据库（无法处理大规模时间序列数据）

**决策5: 分层数据存储架构**
- **选择**: 创建多个专门的ClickHouse表分别存储不同类型的数据：
  - `user_positions`: 当前持仓数据（ReplacingMergeTree）
  - `position_history`: 持仓历史变更（MergeTree）
  - `daily_analysis_reports`: AI分析报告（ReplacingMergeTree）
  - `technical_indicators`: 技术指标数据（ReplacingMergeTree）
  - `portfolio_risk_metrics`: 风险指标（ReplacingMergeTree）
- **原因**: 
  - 充分利用ClickHouse的列式存储优势
  - 支持高效的历史数据查询和分析
  - 便于数据分区和优化
- **替代方案**: 单表存储（查询性能差，数据冗余严重）

### 前端技术决策

**决策6: 使用组合式API和TypeScript**
- **选择**: Vue 3 Composition API + TypeScript + Pinia状态管理
- **原因**: 类型安全，代码可维护性高，符合现代前端开发趋势
- **替代方案**: Options API（功能有限，不利于复杂逻辑组织）

**决策7: 采用图表库进行数据可视化**
- **选择**: 使用ECharts或Chart.js进行图表展示
- **原因**: 功能丰富，社区活跃，支持多种图表类型
- **替代方案**: 自研图表组件（开发成本高，功能有限）

## Risks / Trade-offs

### 风险识别与缓解

**风险1: 数据一致性问题**
- **描述**: 实时价格更新可能导致持仓数据不一致
- **缓解**: 使用数据库事务和乐观锁机制，定期数据校验

**风险2: AI分析性能问题**
- **描述**: 大量持仓的AI分析可能导致响应缓慢
- **缓解**: 实现异步分析，使用缓存机制，分批处理

**风险3: 定时任务可靠性**
- **描述**: 定时任务失败可能导致分析数据缺失
- **缓解**: 实现任务重试机制，添加监控和告警

### 技术权衡

**权衡1: 实时性 vs 性能**
- **选择**: 准实时更新（5分钟间隔）而非实时更新
- **原因**: 平衡用户体验和系统性能，减少API调用成本

**权衡2: 功能完整性 vs 开发复杂度**
- **选择**: 分阶段实现，先核心功能后高级功能
- **原因**: 快速交付价值，降低开发风险

## Migration Plan

### 数据迁移
1. **阶段1**: 验证现有ClickHouse表结构，确保兼容性
2. **阶段2**: 创建新的分析相关表（technical_indicators, portfolio_risk_metrics等）
3. **阶段3**: 迁移现有持仓数据，验证数据完整性

### 功能迁移
1. **阶段1**: 部署后端API和服务，利用现有ClickHouse连接
2. **阶段2**: 发布前端界面，支持新旧功能并存
3. **阶段3**: 启用定时任务和AI分析功能

### 回滚计划
- 保留现有API接口，支持快速回滚
- ClickHouse表结构变更使用可逆的DDL语句
- 前端功能使用特性开关控制
- 利用ClickHouse的分区特性，支持按时间回滚数据

## Open Questions

1. **用户认证**: 是否需要实现用户登录和权限管理？
   - **当前假设**: 单用户系统，无需认证
   - **后续考虑**: 如需多用户支持，可扩展现有架构

2. **数据源集成**: 是否需要支持多个数据源的价格数据？
   - **当前假设**: 使用现有的Tushare数据源
   - **后续考虑**: 可通过插件机制扩展其他数据源

3. **移动端支持**: 是否需要开发移动端应用？
   - **当前假设**: 仅支持Web端，响应式设计
   - **后续考虑**: 可基于现有API开发移动端应用

4. **国际化支持**: 是否需要支持多语言？
   - **当前假设**: 仅支持中文
   - **后续考虑**: 可通过i18n机制添加多语言支持