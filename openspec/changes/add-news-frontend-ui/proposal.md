# Change: 新增新闻资讯前端页面（NewsView）

## Why

当前系统已经实现了 NewsAnalystAgent 后端功能（`add-news-analyst-agent` 提案），提供了完整的新闻获取、情绪分析、热点追踪等 API 接口，但缺乏对应的前端展示页面。用户需要通过自然语言对话才能获取新闻信息，缺乏直观的新闻浏览和管理界面。

参考现有的前端架构（MarketView、ScreenerView、ReportView 等），新闻资讯作为投资决策的重要信息源，需要独立的前端页面来提供：

1. **新闻浏览体验** - 分类展示市场新闻、公司公告、热点资讯
2. **智能筛选功能** - 按股票、时间、情绪、热度等维度筛选新闻
3. **可视化分析** - 新闻情绪趋势图、热点词云、影响力分析
4. **个性化推荐** - 基于用户关注股票推荐相关新闻
5. **AI 辅助分析** - 新闻摘要生成、影响分析、投资建议

这将完善 A 股赛博操盘手平台的信息获取能力，为用户提供专业的新闻资讯服务。

## What Changes

### 前端新增
- **新增 NewsView 页面** - 新闻资讯主页面，遵循现有 Vue 3 + TDesign 架构
- **新增 news 相关组件** - 新闻列表、筛选器、分析面板等可复用组件
- **新增 news API 封装** - 前端 API 调用层，对接后端新闻接口
- **新增 news 状态管理** - Pinia store 管理新闻数据和用户偏好
- **新增路由配置** - 添加 `/news` 路由到导航系统

### 页面功能
- **新闻列表展示** - 支持无限滚动、实时刷新、多种排序方式
- **智能筛选面板** - 股票代码、时间范围、新闻类型、情绪标签筛选
- **新闻详情弹窗** - 完整新闻内容、AI 分析结果、相关股票信息
- **情绪分析可视化** - 情绪分布饼图、情绪趋势折线图
- **热点话题面板** - 当前市场热点、关键词云图、相关新闻聚合
- **个人关注管理** - 关注股票新闻订阅、自定义筛选条件保存

### 集成现有系统
- **导航菜单集成** - 在主导航中添加"新闻资讯"入口
- **股票详情联动** - 从其他页面跳转到相关股票新闻
- **AI 对话集成** - 支持从对话页面快速跳转到新闻详情

## Impact

- **Affected specs**: 新增 `news-frontend` capability
- **Affected code**:
  - `frontend/src/views/news/` - 新增新闻页面组件
  - `frontend/src/api/news.ts` - 新增新闻 API 封装
  - `frontend/src/stores/news.ts` - 新增新闻状态管理
  - `frontend/src/router/index.ts` - 添加新闻路由
  - `frontend/src/App.vue` - 更新主导航菜单

## Out of Scope

- 新闻内容编辑功能（只读展示）
- 新闻评论和社交功能（可后续扩展）
- 新闻推送通知（可后续扩展）
- 移动端适配优化（可后续扩展）

## Dependencies

- **强依赖**: `add-news-analyst-agent` 提案必须已完成实现
- **API 依赖**: 依赖后端 `/api/news/*` 接口正常工作
- **数据依赖**: 依赖 NewsAnalystAgent 提供的新闻数据和分析结果

## User Experience

### 主要用户流程
1. **浏览新闻** - 用户访问 `/news` 页面，查看最新市场新闻
2. **筛选新闻** - 通过筛选面板按股票、时间、类型等条件筛选
3. **查看详情** - 点击新闻标题查看完整内容和 AI 分析
4. **关注管理** - 添加关注股票，获取个性化新闻推荐
5. **热点追踪** - 查看当前市场热点话题和相关新闻聚合

### 页面布局设计
```
┌─────────────────────────────────────────────────────────────────┐
│                        新闻资讯 - NewsView                        │
├─────────────────────────────────────────────────────────────────┤
│ 筛选面板 │                    新闻列表                          │
│ ┌─────┐  │  ┌─────────────────────────────────────────────┐   │
│ │股票  │  │  │ [利好] 茅台Q3业绩超预期，净利润同比增长15%    │   │
│ │筛选  │  │  │ 来源：财联社 | 2小时前 | 情绪：积极 ⭐⭐⭐⭐⭐  │   │
│ └─────┘  │  └─────────────────────────────────────────────┘   │
│ ┌─────┐  │  ┌─────────────────────────────────────────────┐   │
│ │时间  │  │  │ [中性] 央行维持MLF利率不变，市场预期稳定     │   │
│ │范围  │  │  │ 来源：新华社 | 3小时前 | 情绪：中性 ⭐⭐⭐     │   │
│ └─────┘  │  └─────────────────────────────────────────────┘   │
│ ┌─────┐  │                                                   │
│ │新闻  │  │                热点话题面板                        │
│ │类型  │  │  ┌─────────────────────────────────────────┐     │
│ └─────┘  │  │ 🔥 新能源汽车 (热度:95) 📈 芯片概念 (热度:87) │     │
│          │  └─────────────────────────────────────────┘     │
└─────────────────────────────────────────────────────────────────┘
```

## Technical Approach

遵循现有前端架构模式：
- **Vue 3 Composition API** - 使用 `<script setup>` 语法
- **TDesign Vue Next** - 使用统一的 UI 组件库
- **Pinia 状态管理** - 管理新闻数据和用户偏好
- **Axios HTTP 客户端** - 封装新闻 API 调用
- **ECharts 图表库** - 实现情绪分析和热点可视化

参考现有页面实现模式（如 MarketView、ScreenerView），确保代码风格和用户体验的一致性。

---

## Implementation Progress

### 已完成的功能

#### 1. 空状态 UI 优化 ✅
优化了各组件的"暂无数据"显示效果：

- **NewsListPanel.vue** - 新闻列表空状态
  - 自定义 SVG 图标（新闻文章样式）
  - 渐变色填充和浮动动画
  - 脉冲动画装饰点
  - 带图标的"刷新数据"按钮

- **HotTopicsPanel.vue** - 热点话题空状态
  - 星星/火焰风格 SVG 图标
  - 温暖的橙红色渐变
  - 轻微浮动动画

- **SentimentChart.vue** - 情绪分析空状态
  - 圆形仪表盘风格 SVG 图标
  - 三色渐变（正面/中性/负面）
  - 缓慢旋转动画

#### 2. 后端 API 完善 ✅
添加了前端需要的筛选选项接口：

- **GET /api/news/categories** - 新闻分类列表
  - 返回：全部、公告、快讯、分析、政策、行业

- **GET /api/news/sources** - 新闻来源列表（已精简）
  - 返回：全部来源、公告数据（Tushare）、财经新闻（新浪）

#### 3. 数据源安全性确认 ✅
确认当前实现的数据源是安全合规的：

| 数据源 | 来源 | 说明 |
|--------|------|------|
| Tushare | 官方 API | 上市公司公告，付费数据服务 |
| 新浪财经 | 公开 API | `feed.mix.sina.com.cn`，公开接口 |

**注意**：前端下拉框中曾显示"东方财富、同花顺、雪球"等来源，但后端并未实际爬取这些平台，已修正为只显示实际实现的数据源。

#### 4. 性能优化 ✅
- **后端 /list 接口优化**
  - 添加快速路径：无筛选条件时直接返回，避免不必要遍历
  - 动态计算获取数量，减少冗余数据获取
  - 响应时间：首次约 1-2 秒，缓存命中后约 0.1-0.3 秒

- **前端防重复请求**
  - 添加 `isInitialized` 标志，防止初始化时重复请求
  - 添加 `isFetching` 请求锁，防止并发请求
  - 优化 watch 监听，只在初始化完成后响应路由变化

- **缓存策略**
  - 快讯类新闻：缓存 5 分钟
  - 公告类新闻：缓存 1 小时
  - 热点话题：缓存 10 分钟

#### 5. Store 逻辑修复 ✅
- **fetchMarketNews** - 修复缓存数据格式问题
  - 缓存返回 `NewsItem[]`，需要正确构建 `NewsListResponse` 对象
  
- **filteredNews** - 简化过滤逻辑
  - 由于过滤已在 API 请求时完成，本地只做关键词过滤
  - 避免重复过滤导致数据为空

#### 6. 数据响应式传递修复 ✅
修复了新闻列表数据获取成功但页面显示"共0条"的问题：

**问题现象**：
- API 返回 20 条新闻数据 ✅
- Store 中 `newsItems.value.length = 20` ✅
- `filteredNews` computed 计算结果 = 20 条 ✅
- 但 `NewsListPanel` 组件显示"共0条" ❌

**根本原因**：
`storeToRefs` 对 Pinia store 中的 computed 属性（getter）进行解构时，返回的是 `ComputedRef` 类型。在 Vue 模板中直接使用时，响应式更新可能存在时序问题，导致子组件接收到的是初始空值，后续更新没有正确传递。

**修复方案**：
```typescript
// NewsView.vue - 修改前
const { filteredNews, ... } = storeToRefs(newsStore)

// NewsView.vue - 修改后
const { ... } = storeToRefs(newsStore)  // 不从 storeToRefs 获取 filteredNews
const filteredNews = computed(() => newsStore.filteredNews)  // 直接包装 store getter
```

**修改文件**：
- `frontend/src/views/news/NewsView.vue` - 修复 `filteredNews` 的响应式传递

### 待完成功能

#### 7. 新闻本地存储优化 ✅ 已完成

**问题现象**：
- 每次访问页面都需要从外部 API（新浪、Tushare）获取新闻
- 外部 API 响应慢（新浪财经 API 可能需要 10-30 秒）
- Redis 缓存只能缓解重复请求，首次请求仍然很慢
- 网络不稳定时容易超时

**已实现：方案 A - JSON 文件存储（轻量级）**

```
┌─────────────────────────────────────────────────────────────────┐
│                    JSON 文件存储方案                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  data/news/                                                     │
│  ├── sina/                                                      │
│  │   ├── 2024-01-28.json      # 按日期分文件                    │
│  │   └── ...                                                    │
│  ├── tushare/                                                   │
│  │   └── ...                                                    │
│  └── cache/                                                     │
│      └── latest.json          # 最新新闻缓存（快速读取）         │
│                                                                 │
│  优势：                                                          │
│  ✅ 零依赖，无需数据库                                           │
│  ✅ 文件可读，方便调试                                           │
│  ✅ 部署简单，直接读写文件                                       │
│  ✅ 自动清理 7 天前的旧文件                                      │
└─────────────────────────────────────────────────────────────────┘
```

**新增的文件和接口**：

1. **存储模块** - `src/stock_datasource/modules/news/storage.py`
   - `NewsFileStorage` 类：实现 JSON 文件存储
   - `save_news()` - 保存新闻到按日期分片的文件
   - `get_latest_news()` - 从缓存快速获取最新新闻
   - `cleanup_old_files()` - 清理旧文件
   - 单例模式 + 内存缓存（60秒 TTL）

2. **新增 API 接口**：
   - `GET /api/news/cache-info` - 获取缓存状态信息
   - `POST /api/news/refresh-cache` - 强制刷新缓存

3. **Service 层集成**：
   - `get_market_news()` 方法优先从本地文件读取
   - 获取新闻后自动保存到本地存储
   - 支持 `force_refresh` 参数强制刷新

**工作流程**：
```
用户请求新闻
    │
    ▼
┌─────────────────────┐
│ 1. 检查本地文件缓存  │ ─── 命中 ──▶ 直接返回（< 0.1s）
└─────────────────────┘
    │ 未命中
    ▼
┌─────────────────────┐
│ 2. 检查 Redis 缓存  │ ─── 命中 ──▶ 返回 + 保存到文件
└─────────────────────┘
    │ 未命中
    ▼
┌─────────────────────┐
│ 3. 调用外部 API     │ ──────────▶ 返回 + 保存到文件 + Redis
└─────────────────────┘
```

**预期效果**：
| 指标 | 优化前 | 优化后 |
|------|--------|--------|
| 首次加载 | 10-30s | < 0.5s（有缓存时） |
| 缓存命中 | 0.1-0.3s | < 0.1s |
| 网络依赖 | 高 | 低 |
| 历史查询 | 不支持 | 支持 7 天 |

---

##### 方案 B：SQLite 数据库存储（备选，未实现）

适合需要复杂查询（全文搜索、多条件筛选）的场景，当新闻量超过 1 万条时可考虑迁移。

- [ ] 新闻详情弹窗的 AI 分析功能
- [ ] 热点话题词云可视化
- [ ] 个人关注管理（关注股票新闻订阅）
- [ ] 移动端适配优化

### 修改的文件清单

```
frontend/src/views/news/
├── NewsView.vue                    # 添加防重复请求逻辑、修复 filteredNews 响应式传递
└── components/
    ├── NewsListPanel.vue           # 空状态 UI 优化、添加调试日志
    ├── HotTopicsPanel.vue          # 空状态 UI 优化
    └── SentimentChart.vue          # 空状态 UI 优化

frontend/src/stores/
└── news.ts                         # 修复缓存格式、简化过滤逻辑

src/stock_datasource/modules/news/
├── __init__.py                     # 导出 NewsFileStorage
├── router.py                       # 添加 /categories、/sources、/cache-info、/refresh-cache 接口
├── service.py                      # 集成文件存储，优化 get_market_news
└── storage.py                      # 🆕 新增 JSON 文件存储模块

data/news/                          # 🆕 新增新闻数据存储目录
├── sina/                           # 新浪新闻（按日期分片）
├── tushare/                        # Tushare 公告（按日期分片）
└── cache/
    └── latest.json                 # 聚合缓存文件

.gitignore                          # 添加 data/news/**/*.json 忽略规则
```