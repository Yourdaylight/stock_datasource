# Proposal: Add Plugin Data Explorer

## Change ID
`add-plugin-data-explorer`

## Summary
æ–°å¢ä¸€ä¸ªç‹¬ç«‹çš„"æ•°æ®æµè§ˆå™¨"é¡µé¢ï¼Œå…è®¸ç”¨æˆ·åŸºäºæ’ä»¶é…ç½®åŠ¨æ€æµè§ˆå¯¹åº”æ•°æ®åº“è¡¨çš„æ•°æ®ï¼Œå¹¶æ”¯æŒ SQL å±‚é¢çš„è‡ªå®šä¹‰æŸ¥è¯¢ã€‚

## Background

### ç°çŠ¶åˆ†æ
1. **å·²æœ‰åŠŸèƒ½**ï¼š
   - æ¯ä¸ªæ’ä»¶çš„ `schema.json` å®šä¹‰äº† `table_name` å’Œåˆ—ä¿¡æ¯
   - `/api/datamanage/plugins/{name}/data` æ¥å£æ”¯æŒæŒ‰æ’ä»¶åè·å–æ•°æ®é¢„è§ˆ
   - `PluginDataDialog.vue` å¼¹çª—ç»„ä»¶å®ç°åŸºç¡€çš„æ•°æ®æµè§ˆï¼ˆä»…æ”¯æŒæ—¥æœŸç­›é€‰å’Œåˆ†é¡µï¼‰
   - æ•°æ®åº“ä½¿ç”¨ ClickHouseï¼Œæ”¯æŒé«˜æ€§èƒ½ SQL æŸ¥è¯¢

2. **å±€é™æ€§**ï¼š
   - å½“å‰æ•°æ®é¢„è§ˆæ˜¯å¼¹çª—å½¢å¼ï¼Œç©ºé—´æœ‰é™
   - ä»…æ”¯æŒç®€å•çš„æ—¥æœŸç­›é€‰ï¼Œæ— æ³•è¿›è¡Œå¤æ‚æŸ¥è¯¢
   - æ— æ³•è·¨è¡¨æŸ¥è¯¢æˆ–ä½¿ç”¨ SQL èšåˆå‡½æ•°
   - æ— æ³•å¯¼å‡ºæŸ¥è¯¢ç»“æœ

## Goals
1. æä¾›ä¸€ä¸ªç‹¬ç«‹çš„"æ•°æ®æµè§ˆå™¨"é¡µé¢ï¼Œä¸å†ä¾èµ–å¼¹çª—
2. æ”¯æŒåŸºäºæ’ä»¶çš„è¡¨ç»“æ„åŠ¨æ€ç”Ÿæˆåˆ—æ˜¾ç¤º
3. æ”¯æŒ SQL æŸ¥è¯¢æ¨¡å¼ï¼Œå…è®¸ç”¨æˆ·ç¼–å†™è‡ªå®šä¹‰æŸ¥è¯¢
4. æä¾›æŸ¥è¯¢ç»“æœçš„å¯¼å‡ºåŠŸèƒ½ï¼ˆCSV/Excelï¼‰
5. ä¿å­˜å¸¸ç”¨æŸ¥è¯¢æ¨¡æ¿

## Non-Goals
- ä¸æ”¯æŒæ•°æ®å†™å…¥/ä¿®æ”¹æ“ä½œï¼ˆåªè¯»æŸ¥è¯¢ï¼‰
- ä¸æ”¯æŒè·¨æ•°æ®åº“æŸ¥è¯¢ï¼ˆä»…é™ ClickHouseï¼‰
- ä¸æ›¿ä»£ä¸“ä¸šçš„ BI å·¥å…·
- **ä¸æ”¯æŒæŸ¥è¯¢ç»“æœçš„å›¾è¡¨å¯è§†åŒ–**ï¼ˆä»…è¡¨æ ¼å±•ç¤ºï¼‰

## Proposed Solution

### æ¶æ„æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æ•°æ®æµè§ˆå™¨é¡µé¢                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [æ’ä»¶é€‰æ‹©å™¨]  [å¿«é€Ÿç­›é€‰: è¡¨å/åˆ†ç±»]                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ“‹ è¡¨åˆ—è¡¨                    â”‚  ğŸ“Š æ•°æ®æµè§ˆåŒºåŸŸ                           â”‚
â”‚  â”œâ”€ ğŸ“ Aè‚¡æ•°æ®               â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   â”œâ”€ ods_daily            â”‚  â”‚ æ¨¡å¼åˆ‡æ¢: [ç®€å•ç­›é€‰] [SQLæŸ¥è¯¢]        â”‚ â”‚
â”‚  â”‚   â”œâ”€ ods_daily_basic      â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚   â””â”€ ods_adj_factor       â”‚  â”‚                                      â”‚ â”‚
â”‚  â”œâ”€ ğŸ“ æŒ‡æ•°æ•°æ®              â”‚  â”‚  ã€ç®€å•ç­›é€‰æ¨¡å¼ã€‘                       â”‚ â”‚
â”‚  â”‚   â”œâ”€ ods_index_daily      â”‚  â”‚  æ—¥æœŸèŒƒå›´: [____] ~ [____]            â”‚ â”‚
â”‚  â”‚   â””â”€ ods_index_basic      â”‚  â”‚  ä»£ç ç­›é€‰: [____________]             â”‚ â”‚
â”‚  â””â”€ ğŸ“ ETFæ•°æ®               â”‚  â”‚  æ’åº: [åˆ—åâ–¼] [å‡åº/é™åº]             â”‚ â”‚
â”‚      â””â”€ ods_etf_fund_daily   â”‚  â”‚                                      â”‚ â”‚
â”‚                              â”‚  â”‚  ã€SQLæŸ¥è¯¢æ¨¡å¼ã€‘                       â”‚ â”‚
â”‚  è¡¨ä¿¡æ¯:                      â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  è¡Œæ•°: 12,345,678            â”‚  â”‚  â”‚ SELECT * FROM ods_daily        â”‚  â”‚ â”‚
â”‚  åˆ—æ•°: 15                    â”‚  â”‚  â”‚ WHERE ts_code = '000001.SZ'    â”‚  â”‚ â”‚
â”‚  åˆ†åŒº: toYYYYMM(trade_date)  â”‚  â”‚  â”‚ ORDER BY trade_date DESC       â”‚  â”‚ â”‚
â”‚                              â”‚  â”‚  â”‚ LIMIT 100                      â”‚  â”‚ â”‚
â”‚  [æŸ¥çœ‹è¡¨ç»“æ„]                 â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚                              â”‚  â”‚  [è¿è¡ŒæŸ¥è¯¢] [æ ¼å¼åŒ–] [ä¿å­˜æ¨¡æ¿]        â”‚ â”‚
â”‚                              â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚                              â”‚  â”‚ æŸ¥è¯¢ç»“æœ (100 æ¡/å…± 5,234 æ¡)         â”‚ â”‚
â”‚                              â”‚  â”‚ â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚                              â”‚  â”‚ â”‚ä»£ç â”‚ æ—¥æœŸ   â”‚ å¼€ç›˜ä»· â”‚æœ€é«˜ â”‚æœ€ä½ â”‚ â”‚ â”‚
â”‚                              â”‚  â”‚ â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¤ â”‚ â”‚
â”‚                              â”‚  â”‚ â”‚... â”‚  ...   â”‚  ...   â”‚ ... â”‚ ... â”‚ â”‚ â”‚
â”‚                              â”‚  â”‚ â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚                              â”‚  â”‚ [å¯¼å‡ºCSV] [å¯¼å‡ºExcel]   åˆ†é¡µ: < 1 > â”‚ â”‚ â”‚
â”‚                              â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒåŠŸèƒ½

#### 1. è¡¨åˆ—è¡¨é¢æ¿
- ä»æ‰€æœ‰å·²æ³¨å†Œæ’ä»¶çš„ `schema.json` è¯»å–è¡¨ä¿¡æ¯
- æŒ‰åˆ†ç±»ï¼ˆAè‚¡/æŒ‡æ•°/ETF/å…¶ä»–ï¼‰åˆ†ç»„å±•ç¤º
- æ˜¾ç¤ºè¡¨çš„åŸºç¡€ä¿¡æ¯ï¼ˆè¡Œæ•°ã€åˆ—æ•°ã€åˆ†åŒºæ–¹å¼ï¼‰
- æ”¯æŒæœç´¢è¿‡æ»¤

#### 2. ç®€å•ç­›é€‰æ¨¡å¼
- æ—¥æœŸèŒƒå›´é€‰æ‹©å™¨
- è‚¡ç¥¨ä»£ç ç­›é€‰ï¼ˆæ”¯æŒæ¨¡ç³Šæœç´¢ï¼‰
- åˆ—æ’åº
- åˆ†é¡µæµè§ˆ

#### 3. SQL æŸ¥è¯¢æ¨¡å¼
- **å¤š Tab SQL ç¼–è¾‘å™¨**ï¼ˆæ”¯æŒåŒæ—¶ç¼–è¾‘å¤šä¸ªæŸ¥è¯¢ï¼‰
- SQL è¯­æ³•é«˜äº®
- è¡¨å/åˆ—åè‡ªåŠ¨è¡¥å…¨
- æŸ¥è¯¢æ‰§è¡Œä¸ç»“æœå±•ç¤º
- æŸ¥è¯¢æ¨¡æ¿ä¿å­˜/åŠ è½½
- **æŸ¥è¯¢å†å²è®°å½•ï¼ˆå‰ç«¯ localStorage å­˜å‚¨ï¼‰**

#### 4. å®‰å…¨æ§åˆ¶
- åªå…è®¸ SELECT è¯­å¥
- é™åˆ¶æŸ¥è¯¢è¿”å›è¡Œæ•°ï¼ˆæœ€å¤§ 10000 è¡Œï¼‰
- é™åˆ¶æŸ¥è¯¢æ‰§è¡Œæ—¶é—´ï¼ˆæœ€å¤§ 30 ç§’ï¼‰
- ç®¡ç†å‘˜å¯é…ç½® SQL ç™½åå•/é»‘åå•

### API è®¾è®¡

```
# è·å–æ‰€æœ‰å¯æŸ¥è¯¢çš„è¡¨åˆ—è¡¨
GET /api/datamanage/tables
Response: { tables: [{ plugin_name, table_name, category, columns, row_count }] }

# è·å–è¡¨ç»“æ„è¯¦æƒ…
GET /api/datamanage/tables/{table_name}/schema
Response: { table_name, columns, partition_by, order_by, engine, comment }

# ç®€å•æŸ¥è¯¢ï¼ˆç­›é€‰æ¨¡å¼ï¼‰
POST /api/datamanage/tables/{table_name}/query
Body: { filters: {...}, sort_by, sort_order, page, page_size }

# SQL æŸ¥è¯¢
POST /api/datamanage/sql/execute
Body: { sql: "SELECT ...", max_rows: 1000 }
Response: { columns, data, row_count, execution_time }

# å¯¼å‡ºæŸ¥è¯¢ç»“æœ
POST /api/datamanage/sql/export
Body: { sql: "SELECT ...", format: "csv" | "xlsx" }
Response: æ–‡ä»¶æµ

# æŸ¥è¯¢æ¨¡æ¿ç®¡ç†
GET    /api/datamanage/sql/templates
POST   /api/datamanage/sql/templates
DELETE /api/datamanage/sql/templates/{id}
```

## Affected Components

### Backend
- `src/stock_datasource/modules/datamanage/router.py` - æ–°å¢ API ç«¯ç‚¹
- `src/stock_datasource/modules/datamanage/service.py` - æ–°å¢æŸ¥è¯¢æœåŠ¡
- `src/stock_datasource/modules/datamanage/schemas.py` - æ–°å¢æ•°æ®æ¨¡å‹
- `src/stock_datasource/modules/datamanage/sql_validator.py` - SQL å®‰å…¨æ ¡éªŒï¼ˆæ–°æ–‡ä»¶ï¼‰

### Frontend
- `frontend/src/views/datamanage/DataExplorerView.vue` - æ–°é¡µé¢ï¼ˆæ–°æ–‡ä»¶ï¼‰
- `frontend/src/views/datamanage/components/TableListPanel.vue` - è¡¨åˆ—è¡¨ç»„ä»¶ï¼ˆæ–°æ–‡ä»¶ï¼‰
- `frontend/src/views/datamanage/components/SqlEditorTabs.vue` - å¤š Tab SQL ç¼–è¾‘å™¨ç»„ä»¶ï¼ˆæ–°æ–‡ä»¶ï¼‰
- `frontend/src/views/datamanage/components/QueryResultTable.vue` - æŸ¥è¯¢ç»“æœè¡¨æ ¼ï¼ˆæ–°æ–‡ä»¶ï¼‰
- `frontend/src/api/datamanage.ts` - æ–°å¢ API æ–¹æ³•
- `frontend/src/router/index.ts` - æ–°å¢è·¯ç”±ï¼ˆä½œä¸ºæ•°æ®ç®¡ç†çš„å­è·¯ç”±ï¼‰
- `frontend/src/composables/useQueryHistory.ts` - æŸ¥è¯¢å†å²è®°å½• composableï¼ˆæ–°æ–‡ä»¶ï¼‰

## Security Considerations

1. **SQL æ³¨å…¥é˜²æŠ¤**
   - ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢
   - SQL è¯­å¥ç™½åå•æ ¡éªŒï¼ˆåªå…è®¸ SELECTï¼‰
   - ç¦æ­¢å±é™©å…³é”®å­—ï¼ˆDROP, DELETE, INSERT, UPDATE, TRUNCATE ç­‰ï¼‰

2. **èµ„æºé™åˆ¶**
   - æŸ¥è¯¢è¶…æ—¶é™åˆ¶ï¼ˆ30 ç§’ï¼‰
   - è¿”å›è¡Œæ•°é™åˆ¶ï¼ˆ10000 è¡Œï¼‰
   - å¹¶å‘æŸ¥è¯¢æ•°é™åˆ¶

3. **æƒé™æ§åˆ¶**
   - SQL æŸ¥è¯¢æ¨¡å¼éœ€è¦ç®¡ç†å‘˜æƒé™
   - ç®€å•ç­›é€‰æ¨¡å¼å¯¹æ‰€æœ‰ç”¨æˆ·å¼€æ”¾

## Alternatives Considered

1. **ä½¿ç”¨ç°æœ‰å¼¹çª—æ‰©å±•**
   - ä¼˜ç‚¹ï¼šæ”¹åŠ¨å°
   - ç¼ºç‚¹ï¼šç©ºé—´å—é™ï¼Œæ— æ³•æ”¯æŒå¤æ‚æŸ¥è¯¢
   
2. **é›†æˆç¬¬ä¸‰æ–¹ BI å·¥å…·ï¼ˆå¦‚ Metabaseï¼‰**
   - ä¼˜ç‚¹ï¼šåŠŸèƒ½ä¸°å¯Œ
   - ç¼ºç‚¹ï¼šå¢åŠ éƒ¨ç½²å¤æ‚åº¦ï¼Œä¸ç°æœ‰ç³»ç»Ÿé›†æˆå›°éš¾

3. **ä»…æä¾› APIï¼Œè®©ç”¨æˆ·ç”¨å…¶ä»–å·¥å…·æŸ¥è¯¢**
   - ä¼˜ç‚¹ï¼šæœ€ç®€å•
   - ç¼ºç‚¹ï¼šç”¨æˆ·ä½“éªŒå·®

## Implementation Plan

å‚è§ `tasks.md`

## Decisions Made

1. **ä¸æ”¯æŒ**æŸ¥è¯¢ç»“æœçš„å›¾è¡¨å¯è§†åŒ–ï¼ˆä»…è¡¨æ ¼å±•ç¤ºï¼‰
2. SQL ç¼–è¾‘å™¨**æ”¯æŒå¤š Tab**ï¼Œå¯åŒæ—¶ç¼–è¾‘å¤šä¸ªæŸ¥è¯¢
3. æŸ¥è¯¢å†å²è®°å½•**åœ¨å‰ç«¯ localStorage ä¿å­˜**ï¼Œæ— éœ€åç«¯å­˜å‚¨
4. æ•°æ®æµè§ˆå™¨ä½œä¸º**æ•°æ®ç®¡ç†çš„äºŒçº§èœå•**ï¼Œè·¯ç”±ä¸º `/datamanage/explorer`
