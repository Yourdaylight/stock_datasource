## ADDED Requirements

### Requirement: 工作流管理

系统 SHALL 提供自定义AI工作流的创建、编辑、删除和查询功能。

#### Scenario: 创建工作流
- **WHEN** 用户填写工作流名称、描述、选择工具并编写提示词
- **THEN** 系统保存工作流配置并返回工作流ID

#### Scenario: 编辑工作流
- **WHEN** 用户修改已有工作流的配置
- **THEN** 系统更新工作流配置

#### Scenario: 删除工作流
- **WHEN** 用户删除工作流
- **THEN** 系统移除工作流配置

#### Scenario: 查询工作流列表
- **WHEN** 用户访问工作流列表页
- **THEN** 系统返回用户的所有工作流（包含模板）

---

### Requirement: 工具选择

系统 SHALL 允许用户从可用的MCP工具列表中选择要在工作流中使用的工具。

#### Scenario: 获取可用工具列表
- **WHEN** 用户打开工作流编辑器
- **THEN** 系统显示所有可用MCP工具及其描述和参数说明

#### Scenario: 选择工具
- **WHEN** 用户勾选工具
- **THEN** 该工具被添加到工作流的工具集中，AI在执行时可调用该工具

#### Scenario: 取消选择工具
- **WHEN** 用户取消勾选工具
- **THEN** 该工具从工作流的工具集中移除

---

### Requirement: 提示词配置

系统 SHALL 支持用户配置系统提示词和用户提示词模板。

#### Scenario: 编辑系统提示词
- **WHEN** 用户编辑系统提示词
- **THEN** 系统提示词用于定义AI的角色和行为规范

#### Scenario: 编辑用户提示词模板
- **WHEN** 用户编辑用户提示词模板并使用变量占位符（如 `{{stock_code}}`）
- **THEN** 执行时变量将被替换为实际值

---

### Requirement: 变量配置

系统 SHALL 支持用户定义工作流变量，在执行时动态输入。

#### Scenario: 添加变量
- **WHEN** 用户添加变量并指定名称、类型、是否必填
- **THEN** 变量可在提示词模板中通过 `{{变量名}}` 引用

#### Scenario: 执行时填写变量
- **WHEN** 用户执行工作流
- **THEN** 系统提示用户填写所有必填变量

---

### Requirement: 工作流执行

系统 SHALL 支持执行工作流并以流式方式返回结果。

#### Scenario: 执行工作流
- **WHEN** 用户填写变量值并确认执行
- **THEN** 系统替换提示词中的变量，使用选定工具调用AI，流式返回分析结果

#### Scenario: 显示执行状态
- **WHEN** 工作流执行中
- **THEN** 前端显示思考状态、工具调用状态和流式内容输出

#### Scenario: 执行失败处理
- **WHEN** 工作流执行失败
- **THEN** 系统返回错误信息并显示给用户

---

### Requirement: 工作流模板

系统 SHALL 提供预置的工作流模板供用户参考和使用。

#### Scenario: 查看模板列表
- **WHEN** 用户访问模板列表
- **THEN** 系统显示所有预置模板

#### Scenario: 从模板创建工作流
- **WHEN** 用户选择模板并点击"使用此模板"
- **THEN** 系统创建工作流副本供用户编辑

---

### Requirement: 工作流编辑器界面

前端 SHALL 提供可视化的工作流编辑器界面。

#### Scenario: 打开编辑器
- **WHEN** 用户进入工作流编辑页面
- **THEN** 显示工具选择面板、提示词编辑区、变量配置区

#### Scenario: 工具搜索
- **WHEN** 用户在工具面板中输入搜索关键词
- **THEN** 工具列表按名称和描述过滤显示

#### Scenario: 保存工作流
- **WHEN** 用户点击保存按钮
- **THEN** 验证必填项后保存工作流配置

#### Scenario: 运行工作流
- **WHEN** 用户在编辑器中点击运行按钮
- **THEN** 弹出变量输入对话框，确认后执行工作流

---

### Requirement: AI辅助生成工作流

系统 SHALL 支持用户通过自然语言描述来让AI自动生成工作流配置。

#### Scenario: 打开AI生成对话框
- **WHEN** 用户在工作流列表或编辑器中点击"AI智能生成"按钮
- **THEN** 系统弹出AI生成工作流对话框

#### Scenario: 输入策略描述
- **WHEN** 用户在对话框中输入分析策略或交易方式的描述
- **THEN** 系统接受用户输入并准备生成工作流

#### Scenario: AI生成工作流
- **WHEN** 用户点击"生成工作流"按钮
- **THEN** 系统调用AI流式生成工作流配置，显示思考过程
- **AND** 生成完成后显示工作流预览

#### Scenario: 应用生成结果
- **WHEN** 用户确认AI生成的工作流配置
- **THEN** 系统将配置填充到工作流编辑器中，用户可进一步调整

#### Scenario: 重新生成
- **WHEN** 用户对生成结果不满意
- **THEN** 用户可修改描述后重新生成

---

### Requirement: AI理解交易策略

系统 SHALL 支持AI理解用户描述的各类交易策略并生成对应工作流。

#### Scenario: 价值投资策略
- **WHEN** 用户描述"分析低估值高股息的股票"
- **THEN** AI选择估值、财务指标等工具，生成价值投资分析工作流

#### Scenario: 技术分析策略
- **WHEN** 用户描述"分析股票的均线和成交量趋势"
- **THEN** AI选择日线数据工具，生成技术分析工作流

#### Scenario: 行业对比策略
- **WHEN** 用户描述"对比同行业几家公司的财务表现"
- **THEN** AI选择财务和行业数据工具，生成行业对比工作流

#### Scenario: 综合筛选策略
- **WHEN** 用户描述"筛选PE低于20、ROE高于15%、近3年利润增长的股票"
- **THEN** AI生成包含估值、财务筛选条件的工作流
