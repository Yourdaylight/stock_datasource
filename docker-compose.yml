# docker-compose.yml - Main application services
# Usage:
#   Full deployment:  docker-compose -f docker-compose.yml -f docker-compose.infra.yml up -d
#   App only:         docker-compose up -d (connect to existing infra)
#   Development:      docker-compose -f docker-compose.yml -f docker-compose.infra.yml -f docker-compose.dev.yml up
#
# (If your machine supports Docker Compose v2 plugin, these also work: docker compose ...)

services:
  backend:
    build:
      context: .
      dockerfile: docker/Dockerfile.backend
    container_name: stock-backend
    restart: unless-stopped
    expose:
      - "6666"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      # Timezone
      TZ: Asia/Shanghai
      # ClickHouse (默认用宿主机，通过 host.docker.internal)
      CLICKHOUSE_HOST: ${CLICKHOUSE_HOST:-host.docker.internal}
      CLICKHOUSE_PORT: ${CLICKHOUSE_PORT:-9000}
      CLICKHOUSE_HTTP_PORT: ${CLICKHOUSE_HTTP_PORT:-8123}
      CLICKHOUSE_USER: ${CLICKHOUSE_USER:-default}
      CLICKHOUSE_PASSWORD: ${CLICKHOUSE_PASSWORD:-}
      CLICKHOUSE_DATABASE: ${CLICKHOUSE_DATABASE:-stock_datasource}
      # Redis (use stock-redis container via docker network)
      REDIS_HOST: ${REDIS_HOST:-redis}
      REDIS_PORT: ${REDIS_PORT:-6379}
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
      REDIS_DB: ${REDIS_DB:-1}
      # Langfuse (默认用宿主机)
      LANGFUSE_HOST: ${LANGFUSE_HOST:-http://host.docker.internal:3000}
      LANGFUSE_PUBLIC_KEY: ${LANGFUSE_PUBLIC_KEY:-}
      LANGFUSE_SECRET_KEY: ${LANGFUSE_SECRET_KEY:-}
      # API Keys
      TUSHARE_TOKEN: ${TUSHARE_TOKEN:-}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      OPENAI_BASE_URL: ${OPENAI_BASE_URL:-https://api.openai.com/v1}
      OPENAI_MODEL: ${OPENAI_MODEL:-gpt-4}
      # Auth / Registration
      AUTH_EMAIL_WHITELIST_ENABLED: ${AUTH_EMAIL_WHITELIST_ENABLED:-false}
      AUTH_EMAIL_WHITELIST_FILE: ${AUTH_EMAIL_WHITELIST_FILE:-data/email.txt}
      # WeKnora Knowledge Base (optional)
      WEKNORA_ENABLED: ${WEKNORA_ENABLED:-false}
      WEKNORA_BASE_URL: ${WEKNORA_BASE_URL:-http://weknora-app:8080/api/v1}
      WEKNORA_API_KEY: ${WEKNORA_API_KEY:-}
      WEKNORA_KB_IDS: ${WEKNORA_KB_IDS:-}
      WEKNORA_TIMEOUT: ${WEKNORA_TIMEOUT:-10}
    volumes:
      - ./logs:/app/logs
      - ./data:/app/data
    networks:
      - stock_network
      - langfuse_default
    healthcheck:
      test: curl -f http://localhost:6666/health || exit 1
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  frontend:
    build:
      context: ./frontend
      dockerfile: ../docker/Dockerfile.frontend
      target: ${FRONTEND_TARGET:-production}
    container_name: stock-frontend
    restart: unless-stopped
    ports:
      - "${APP_PORT:-18080}:6666"
    environment:
      VITE_API_BASE_URL: ${VITE_API_BASE_URL:-}
    networks:
      - stock_network
    depends_on:
      backend:
        condition: service_healthy

  # Task worker for processing sync tasks from Redis queue
  worker:
    build:
      context: .
      dockerfile: docker/Dockerfile.backend
    container_name: stock-worker
    restart: unless-stopped
    command: ["uv", "run", "python", "-m", "stock_datasource.services.task_worker", "--workers", "2"]
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      # Timezone
      TZ: Asia/Shanghai
      # ClickHouse
      CLICKHOUSE_HOST: ${CLICKHOUSE_HOST:-host.docker.internal}
      CLICKHOUSE_PORT: ${CLICKHOUSE_PORT:-9000}
      CLICKHOUSE_HTTP_PORT: ${CLICKHOUSE_HTTP_PORT:-8123}
      CLICKHOUSE_USER: ${CLICKHOUSE_USER:-default}
      CLICKHOUSE_PASSWORD: ${CLICKHOUSE_PASSWORD:-}
      CLICKHOUSE_DATABASE: ${CLICKHOUSE_DATABASE:-stock_datasource}
      # Redis
      REDIS_HOST: ${REDIS_HOST:-stock-redis}
      REDIS_PORT: ${REDIS_PORT:-6379}
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
      REDIS_DB: ${REDIS_DB:-1}
      # API Keys
      TUSHARE_TOKEN: ${TUSHARE_TOKEN:-}
    volumes:
      - ./logs:/app/logs
      - ./data:/app/data
    networks:
      - stock_network
      - langfuse_default
    depends_on:
      backend:
        condition: service_healthy
    healthcheck:
      disable: true

networks:
  stock_network:
    name: stock_network
    driver: bridge
  langfuse_default:
    external: true
