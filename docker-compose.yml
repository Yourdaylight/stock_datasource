# docker-compose.yml - Main application services
# Usage:
#   Full deployment:  docker-compose -f docker-compose.yml -f docker-compose.infra.yml up -d
#   App only:         docker-compose up -d (connect to existing infra)
#   Development:      docker-compose -f docker-compose.yml -f docker-compose.infra.yml -f docker-compose.dev.yml up
#
# (If your machine supports Docker Compose v2 plugin, these also work: docker compose ...)

services:
  backend:
    build:
      context: .
      dockerfile: docker/Dockerfile.backend
    container_name: stock-backend
    restart: unless-stopped
    expose:
      - "6666"
    environment:
      # ClickHouse (use stock-clickhouse container via docker network)
      CLICKHOUSE_HOST: ${CLICKHOUSE_HOST:-clickhouse}
      CLICKHOUSE_PORT: ${CLICKHOUSE_PORT:-9000}
      CLICKHOUSE_HTTP_PORT: ${CLICKHOUSE_HTTP_PORT:-8123}
      CLICKHOUSE_USER: ${CLICKHOUSE_USER:-clickhouse}
      CLICKHOUSE_PASSWORD: ${CLICKHOUSE_PASSWORD:-clickhouse}
      CLICKHOUSE_DATABASE: ${CLICKHOUSE_DATABASE:-stock_datasource}
      # Redis (use stock-redis container via docker network)
      REDIS_HOST: ${REDIS_HOST:-redis}
      REDIS_PORT: ${REDIS_PORT:-6379}
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
      REDIS_DB: ${REDIS_DB:-1}
      # Langfuse
      LANGFUSE_HOST: ${LANGFUSE_HOST:-http://langfuse-web:3000}
      LANGFUSE_PUBLIC_KEY: ${LANGFUSE_PUBLIC_KEY:-}
      LANGFUSE_SECRET_KEY: ${LANGFUSE_SECRET_KEY:-}
      # API Keys
      TUSHARE_TOKEN: ${TUSHARE_TOKEN:-}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      OPENAI_BASE_URL: ${OPENAI_BASE_URL:-https://api.openai.com/v1}
      OPENAI_MODEL: ${OPENAI_MODEL:-gpt-4}
      # Auth / Registration
      AUTH_EMAIL_WHITELIST_ENABLED: ${AUTH_EMAIL_WHITELIST_ENABLED:-false}
      AUTH_EMAIL_WHITELIST_FILE: ${AUTH_EMAIL_WHITELIST_FILE:-data/email.txt}
    volumes:
      - ./logs:/app/logs
      - ./data:/app/data
    networks:
      - stock_network
    healthcheck:
      test: curl -f http://localhost:6666/health || exit 1
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  frontend:
    build:
      context: ./frontend
      dockerfile: ../docker/Dockerfile.frontend
      target: ${FRONTEND_TARGET:-production}
    container_name: stock-frontend
    restart: unless-stopped
    ports:
      - "${APP_PORT:-18080}:6666"
    environment:
      VITE_API_BASE_URL: ${VITE_API_BASE_URL:-}
    networks:
      - stock_network
    depends_on:
      backend:
        condition: service_healthy

networks:
  stock_network:
    name: stock_network
    driver: bridge
