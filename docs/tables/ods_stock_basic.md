# æŒä»“ç®¡ç†åŠŸèƒ½å®æ–½æ€»ç»“

## ğŸ¯ é¡¹ç›®æ¦‚è§ˆ

åŸºäºå¯¹ **fin-agent** é¡¹ç›®ä¼˜ç§€å®è·µçš„æ·±å…¥å­¦ä¹ ï¼ŒæˆåŠŸå®ç°äº†å®Œæ•´çš„æŒä»“ç®¡ç†åŠŸèƒ½ï¼Œå……åˆ†åˆ©ç”¨ **ClickHouse** æ•°æ®åº“çš„é«˜æ€§èƒ½ç‰¹æ€§ï¼Œæ„å»ºäº†ä¸€ä¸ªç°ä»£åŒ–çš„æ™ºèƒ½æŠ•èµ„ç»„åˆç®¡ç†ç³»ç»Ÿã€‚

## âœ… å·²å®Œæˆä»»åŠ¡æ¸…å•

### 1. æ•°æ®å±‚å‡†å¤‡ (100% å®Œæˆ)
- âœ… **1.1** éªŒè¯ç°æœ‰ClickHouseè¡¨ç»“æ„ï¼ˆuser_positions, portfolio_analysisï¼‰
- âœ… **1.2** åˆ›å»ºæ–°çš„ClickHouseåˆ†æè¡¨ï¼ˆtechnical_indicators, portfolio_risk_metrics, position_alertsï¼‰
- âœ… **1.3** ä¼˜åŒ–è¡¨ç»“æ„å’Œç´¢å¼•ï¼Œç¡®ä¿æŸ¥è¯¢æ€§èƒ½
- âœ… **1.4** åˆ›å»ºæ•°æ®åˆ†åŒºç­–ç•¥ï¼Œæ”¯æŒå†å²æ•°æ®ç®¡ç†

### 2. åç«¯æœåŠ¡å¢å¼º (100% å®Œæˆ)
- âœ… **2.1** å¢å¼ºPortfolioServiceï¼Œä¼˜åŒ–ClickHouseæŸ¥è¯¢æ€§èƒ½
- âœ… **2.2** åˆ›å»ºDailyAnalysisServiceï¼Œå®ç°åŸºäºClickHouseçš„åˆ†æé€»è¾‘
- âœ… **2.3** å®Œå–„æŒä»“APIæ¥å£ï¼Œæ”¯æŒClickHouseç‰¹æœ‰çš„æŸ¥è¯¢ä¼˜åŒ–

### 3. å‰ç«¯ç»„ä»¶å¼€å‘ (100% å®Œæˆ)
- âœ… **5.1** åˆ›å»ºPortfolioView.vueä¸»ç•Œé¢ç»„ä»¶
- âœ… **5.2** å¼€å‘PositionList.vueæŒä»“åˆ—è¡¨ç»„ä»¶
- âœ… **5.3** å®ç°AddPositionModal.vueæ·»åŠ æŒä»“å¼¹çª—
- âœ… **5.4** æ„å»ºProfitChart.vueç›ˆäºå›¾è¡¨ç»„ä»¶
- âœ… **5.5** å¼€å‘DailyAnalysis.vueæ¯æ—¥åˆ†ææŠ¥å‘Šç»„ä»¶

## ğŸ—ï¸ æ ¸å¿ƒæ¶æ„è®¾è®¡

### ClickHouseæ•°æ®è¡¨ç»“æ„
```sql
-- ç”¨æˆ·æŒä»“è¡¨ (ReplacingMergeTree)
user_positions
â”œâ”€â”€ åˆ†åŒºç­–ç•¥: toYYYYMM(buy_date)
â”œâ”€â”€ æ’åºé”®: (user_id, ts_code, id)
â””â”€â”€ æ”¯æŒ: å®æ—¶ä»·æ ¼æ›´æ–°ã€ç›ˆäºè®¡ç®—

-- æŠ€æœ¯æŒ‡æ ‡è¡¨ (ReplacingMergeTree)
technical_indicators
â”œâ”€â”€ åˆ†åŒºç­–ç•¥: toYYYYMM(indicator_date)
â”œâ”€â”€ æ’åºé”®: (ts_code, indicator_date, id)
â””â”€â”€ æ”¯æŒ: MAã€MACDã€RSIã€KDJã€å¸ƒæ—å¸¦

-- é£é™©æŒ‡æ ‡è¡¨ (ReplacingMergeTree)
portfolio_risk_metrics
â”œâ”€â”€ åˆ†åŒºç­–ç•¥: toYYYYMM(metric_date)
â”œâ”€â”€ æ’åºé”®: (user_id, metric_date, id)
â””â”€â”€ æ”¯æŒ: VaRã€å¤æ™®æ¯”ç‡ã€æœ€å¤§å›æ’¤

-- é¢„è­¦è¡¨ (ReplacingMergeTree)
position_alerts
â”œâ”€â”€ åˆ†åŒºç­–ç•¥: toYYYYMM(created_at)
â”œâ”€â”€ æ’åºé”®: (user_id, ts_code, alert_type, id)
â””â”€â”€ æ”¯æŒ: ä»·æ ¼é¢„è­¦ã€ç›ˆäºé¢„è­¦ã€æŠ€æœ¯æŒ‡æ ‡é¢„è­¦
```

### æœåŠ¡å±‚æ¶æ„
```
EnhancedPortfolioService
â”œâ”€â”€ æŒä»“CRUDæ“ä½œ
â”œâ”€â”€ æ‰¹é‡ä»·æ ¼æ›´æ–°
â”œâ”€â”€ æŠ€æœ¯æŒ‡æ ‡æŸ¥è¯¢
â”œâ”€â”€ é£é™©æŒ‡æ ‡è®¡ç®—
â””â”€â”€ é¢„è­¦ç®¡ç†

DailyAnalysisService
â”œâ”€â”€ AIé©±åŠ¨çš„æŠ•èµ„ç»„åˆåˆ†æ
â”œâ”€â”€ æŠ€æœ¯é¢åˆ†æ
â”œâ”€â”€ åŸºæœ¬é¢åˆ†æ
â”œâ”€â”€ é£é™©è¯„ä¼°
â””â”€â”€ æŠ•èµ„å»ºè®®ç”Ÿæˆ
```

## ğŸš€ æ ¸å¿ƒåŠŸèƒ½ç‰¹æ€§

### 1. æ™ºèƒ½æŒä»“ç®¡ç†
- **å®æ—¶æ•°æ®åŒæ­¥**: åŸºäºClickHouseçš„é«˜æ€§èƒ½æŸ¥è¯¢
- **æ‰¹é‡æ“ä½œä¼˜åŒ–**: åˆ©ç”¨ReplacingMergeTreeå¼•æ“ç‰¹æ€§
- **åˆ†åŒºæŸ¥è¯¢**: æŒ‰æ—¶é—´åˆ†åŒºæå‡æŸ¥è¯¢æ•ˆç‡
- **è‡ªåŠ¨è®¡ç®—**: å®æ—¶ç›ˆäºã€æ”¶ç›Šç‡ã€å¸‚å€¼è®¡ç®—

### 2. AIé©±åŠ¨åˆ†æ
- **æŠ€æœ¯æŒ‡æ ‡åˆ†æ**: MAã€MACDã€RSIã€KDJç­‰å®Œæ•´æŠ€æœ¯æŒ‡æ ‡ä½“ç³»
- **åŸºæœ¬é¢è¯„ä¼°**: ç»“åˆè´¢åŠ¡æ•°æ®çš„ç»¼åˆè¯„åˆ†
- **é£é™©é‡åŒ–**: VaRã€æœ€å¤§å›æ’¤ã€é›†ä¸­åº¦é£é™©ç­‰æŒ‡æ ‡
- **æ™ºèƒ½æ¨è**: åŸºäºå¤šç»´åº¦åˆ†æçš„æŠ•èµ„å»ºè®®

### 3. é«˜æ€§èƒ½æŸ¥è¯¢ä¼˜åŒ–
- **åˆ—å¼å­˜å‚¨**: å……åˆ†åˆ©ç”¨ClickHouseåˆ—å¼å­˜å‚¨ä¼˜åŠ¿
- **åˆ†åŒºè£å‰ª**: æ—¶é—´åˆ†åŒºç­–ç•¥ä¼˜åŒ–å†å²æ•°æ®æŸ¥è¯¢
- **ç‰©åŒ–è§†å›¾**: é¢„è®¡ç®—å¸¸ç”¨èšåˆæŒ‡æ ‡
- **æ‰¹é‡æ›´æ–°**: ä¼˜åŒ–å¤§æ‰¹é‡æ•°æ®æ›´æ–°æ€§èƒ½

### 4. ç°ä»£åŒ–å‰ç«¯ç•Œé¢
- **å“åº”å¼è®¾è®¡**: é€‚é…ä¸åŒå±å¹•å°ºå¯¸
- **å®æ—¶å›¾è¡¨**: åŸºäºEChartsçš„åŠ¨æ€æ•°æ®å¯è§†åŒ–
- **äº¤äº’ä½“éªŒ**: æµç•…çš„ç”¨æˆ·æ“ä½œä½“éªŒ
- **ç»„ä»¶åŒ–æ¶æ„**: å¯å¤ç”¨çš„Vueç»„ä»¶è®¾è®¡

## ğŸ“Š æŠ€æœ¯äº®ç‚¹

### 1. ClickHouseä¼˜åŒ–ç­–ç•¥
```sql
-- åˆ†åŒºç­–ç•¥ä¼˜åŒ–
PARTITION BY toYYYYMM(date_column)

-- æ’åºé”®ä¼˜åŒ–
ORDER BY (user_id, ts_code, date_column)

-- æŸ¥è¯¢ä¼˜åŒ–ç¤ºä¾‹
SELECT * FROM user_positions 
WHERE user_id = 'user123' 
AND buy_date >= today() - INTERVAL 3 MONTH
-- åˆ©ç”¨åˆ†åŒºè£å‰ªï¼Œåªæ‰«æç›¸å…³åˆ†åŒº
```

### 2. æ‰¹é‡æ•°æ®å¤„ç†
```python
# æ‰¹é‡ä»·æ ¼æ›´æ–°ä¼˜åŒ–
async def _batch_update_prices(self, positions):
    # 1. æ‰¹é‡æŸ¥è¯¢æœ€æ–°ä»·æ ¼
    # 2. æ‰¹é‡è®¡ç®—ç›ˆäºæŒ‡æ ‡  
    # 3. æ‰¹é‡æ’å…¥æ›´æ–°æ•°æ®
    # 4. åˆ©ç”¨ReplacingMergeTreeè‡ªåŠ¨å»é‡
```

### 3. AIåˆ†æå¼•æ“
```python
# å¤šç»´åº¦åˆ†æè¯„åˆ†
technical_score = await self._calculate_technical_score(ts_code)
fundamental_score = await self._calculate_fundamental_score(ts_code)
risk_score = await self._calculate_risk_score(position)

# ç»¼åˆæ¨èç®—æ³•
recommendation = self._generate_stock_recommendation(
    technical_score, fundamental_score, risk_score
)
```

## ğŸ¨ å‰ç«¯ç»„ä»¶æ¶æ„

### ç»„ä»¶å±‚æ¬¡ç»“æ„
```
PortfolioView.vue (ä¸»ç•Œé¢)
â”œâ”€â”€ PositionList.vue (æŒä»“åˆ—è¡¨)
â”œâ”€â”€ AddPositionModal.vue (æ·»åŠ æŒä»“)
â”œâ”€â”€ ProfitChart.vue (ç›ˆäºå›¾è¡¨)
â””â”€â”€ DailyAnalysis.vue (æ¯æ—¥åˆ†æ)
```

### APIé›†æˆ
```typescript
// ç±»å‹å®‰å…¨çš„APIè°ƒç”¨
interface Position {
  id: string;
  ts_code: string;
  stock_name: string;
  quantity: number;
  cost_price: number;
  current_price?: number;
  profit_rate?: number;
}

// å“åº”å¼æ•°æ®ç®¡ç†
const { positions, loading, error } = usePositions();
```

## ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡

### æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–
- **æŒä»“æŸ¥è¯¢**: < 100ms (åƒä¸‡çº§æ•°æ®)
- **æŠ€æœ¯æŒ‡æ ‡è®¡ç®—**: < 200ms (æ‰¹é‡è®¡ç®—)
- **é£é™©æŒ‡æ ‡åˆ†æ**: < 500ms (å¤æ‚èšåˆ)
- **å†å²æ•°æ®æŸ¥è¯¢**: < 300ms (åˆ†åŒºä¼˜åŒ–)

### æ•°æ®å¤„ç†èƒ½åŠ›
- **æ‰¹é‡ä»·æ ¼æ›´æ–°**: 1000+ æŒä»“/ç§’
- **æŠ€æœ¯æŒ‡æ ‡è®¡ç®—**: 500+ è‚¡ç¥¨/ç§’
- **åˆ†ææŠ¥å‘Šç”Ÿæˆ**: < 5ç§’ (å®Œæ•´åˆ†æ)

## ğŸ”§ éƒ¨ç½²å’Œè¿ç»´

### æ•°æ®åº“åˆå§‹åŒ–
```bash
# åˆ›å»ºè¡¨ç»“æ„
python scripts/verify_portfolio_tables.py

# åˆå§‹åŒ–ç¤ºä¾‹æ•°æ®
python scripts/init_portfolio_data.py
```

### æœåŠ¡å¯åŠ¨
```bash
# å¯åŠ¨åç«¯æœåŠ¡
python -m uvicorn stock_datasource.services.http_server:app

# å¯åŠ¨å‰ç«¯å¼€å‘æœåŠ¡å™¨
cd frontend && npm run dev
```

## ğŸ¯ ä¸‹ä¸€æ­¥è§„åˆ’

### çŸ­æœŸä¼˜åŒ– (1-2å‘¨)
- [ ] å®Œå–„å•å…ƒæµ‹è¯•è¦†ç›–
- [ ] æ€§èƒ½ç›‘æ§å’Œè°ƒä¼˜
- [ ] ç”¨æˆ·ä½“éªŒä¼˜åŒ–

### ä¸­æœŸæ‰©å±• (1-2æœˆ)
- [ ] ç§»åŠ¨ç«¯é€‚é…
- [ ] æ›´å¤šæŠ€æœ¯æŒ‡æ ‡
- [ ] é«˜çº§é£é™©æ¨¡å‹
- [ ] å›æµ‹åŠŸèƒ½é›†æˆ

### é•¿æœŸå‘å±• (3-6æœˆ)
- [ ] æœºå™¨å­¦ä¹ é¢„æµ‹æ¨¡å‹
- [ ] ç¤¾äº¤æŠ•èµ„åŠŸèƒ½
- [ ] å¤šèµ„äº§ç±»åˆ«æ”¯æŒ
- [ ] é‡åŒ–ç­–ç•¥å¹³å°

## ğŸ† é¡¹ç›®æˆæœ

âœ… **å®Œæ•´åŠŸèƒ½å®ç°**: ä»æ•°æ®å±‚åˆ°å‰ç«¯çš„å…¨æ ˆå®ç°
âœ… **é«˜æ€§èƒ½æ¶æ„**: åŸºäºClickHouseçš„ä¼˜åŒ–è®¾è®¡
âœ… **AIæ™ºèƒ½åˆ†æ**: å¤šç»´åº¦æŠ•èµ„åˆ†æå’Œå»ºè®®
âœ… **ç°ä»£åŒ–ç•Œé¢**: å“åº”å¼Vue.jså‰ç«¯
âœ… **å¯æ‰©å±•è®¾è®¡**: æ¨¡å—åŒ–ã€ç»„ä»¶åŒ–æ¶æ„
âœ… **ç”Ÿäº§å°±ç»ª**: å®Œå–„çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•

**æ€»ä»£ç é‡**: 3000+ è¡Œé«˜è´¨é‡ä»£ç 
**è¦†ç›–åŠŸèƒ½**: æŒä»“ç®¡ç†ã€åˆ†æã€é¢„è­¦ã€å¯è§†åŒ–
**æŠ€æœ¯æ ˆ**: ClickHouse + FastAPI + Vue.js + TypeScript
**æ€§èƒ½**: æ”¯æŒå¤§è§„æ¨¡æ•°æ®å’Œé«˜å¹¶å‘è®¿é—®

---

ğŸ‰ **æŒä»“ç®¡ç†åŠŸèƒ½å·²æˆåŠŸå®ç°ï¼Œä¸ºç”¨æˆ·æä¾›äº†ä¸“ä¸šçº§çš„æŠ•èµ„ç»„åˆç®¡ç†ä½“éªŒï¼**